name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'sample/pact/**'
      - 'internal/**'
      - 'pkg/**'
      - 'cmd/pact/**'

jobs:
  generate-preview:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build pact
        run: make build

      - name: Get PR head commit ID
        id: commit
        run: echo "id=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Generate SVGs
        run: |
          chmod +x ./scripts/generate-svgs.sh
          chmod +x ./scripts/lib/*.sh
          mkdir -p pr-preview
          ./scripts/generate-svgs.sh ${{ steps.commit.outputs.id }} pr-preview

      - name: Get SVG counts
        id: counts
        run: |
          PREVIEW_DIR="pr-preview/${{ steps.commit.outputs.id }}"
          echo "class=$(find $PREVIEW_DIR/class -name '*.svg' 2>/dev/null | wc -l | tr -d ' ')" >> $GITHUB_OUTPUT
          echo "state=$(find $PREVIEW_DIR/state -name '*.svg' 2>/dev/null | wc -l | tr -d ' ')" >> $GITHUB_OUTPUT
          echo "flow=$(find $PREVIEW_DIR/flow -name '*.svg' 2>/dev/null | wc -l | tr -d ' ')" >> $GITHUB_OUTPUT
          echo "sequence=$(find $PREVIEW_DIR/sequence -name '*.svg' 2>/dev/null | wc -l | tr -d ' ')" >> $GITHUB_OUTPUT

      - name: Check for SVGs
        id: changes
        run: |
          PREVIEW_DIR="pr-preview/${{ steps.commit.outputs.id }}"
          TOTAL=$(find "$PREVIEW_DIR" -name '*.svg' 2>/dev/null | wc -l | tr -d ' ')
          if [ "$TOTAL" -gt 0 ]; then
            echo "has_svgs=true" >> $GITHUB_OUTPUT
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
          else
            echo "has_svgs=false" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload SVG artifacts
        if: steps.changes.outputs.has_svgs == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: svg-preview-${{ steps.commit.outputs.id }}
          path: pr-preview/${{ steps.commit.outputs.id }}/
          retention-days: 30

      - name: Collect SVG file list
        if: steps.changes.outputs.has_svgs == 'true'
        id: svg_list
        run: |
          PREVIEW_DIR="pr-preview/${{ steps.commit.outputs.id }}"
          {
            echo 'files<<SVGLISTEOF'
            for category in class state flow sequence; do
              if [ -d "$PREVIEW_DIR/$category" ]; then
                for svg in "$PREVIEW_DIR/$category"/*.svg; do
                  [ -f "$svg" ] || continue
                  echo "$category/$(basename "$svg")"
                done
              fi
            done
            echo 'SVGLISTEOF'
          } >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: steps.changes.outputs.has_svgs == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const commitId = '${{ steps.commit.outputs.id }}';
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;
            const runId = context.runId;

            const counts = {
              class: ${{ steps.counts.outputs.class }},
              state: ${{ steps.counts.outputs.state }},
              flow: ${{ steps.counts.outputs.flow }},
              sequence: ${{ steps.counts.outputs.sequence }}
            };
            const total = counts.class + counts.state + counts.flow + counts.sequence;

            const artifactUrl = `https://github.com/${owner}/${repo}/actions/runs/${runId}`;

            // Build file list sections per category
            const fileListRaw = `${{ steps.svg_list.outputs.files }}`;
            const files = fileListRaw.split('\n').filter(f => f.trim());
            const categories = ['class', 'state', 'flow', 'sequence'];
            let fileSections = '';
            for (const cat of categories) {
              const catFiles = files.filter(f => f.startsWith(cat + '/'));
              if (catFiles.length > 0) {
                const fileList = catFiles.map(f => `- \`${f.split('/').pop()}\``).join('\n');
                fileSections += `\n<details>\n<summary><b>${cat}</b> (${catFiles.length} files)</summary>\n\n${fileList}\n</details>\n`;
              }
            }

            const body = `## SVG Preview Generated

| Category | Count |
|----------|-------|
| Class | ${counts.class} |
| State | ${counts.state} |
| Flow | ${counts.flow} |
| Sequence | ${counts.sequence} |
| **Total** | **${total}** |

**Artifact**: [Download SVGs](${artifactUrl}) (see \`svg-preview-${commitId}\` artifact)

> Commit: \`${commitId}\`

### Generated Files
${fileSections}
`;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('SVG Preview Generated')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body
              });
            }

      - name: Comment (no changes)
        if: steps.changes.outputs.has_svgs == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            const body = `## SVG Preview

No new SVG files were generated. The sample files may not have changed.
`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });
